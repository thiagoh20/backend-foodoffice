name: Deploy Backend

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  NODE_VERSION: '20'

jobs:
  # test:
  #   name: Ejecutar tests y verificaciones
  #   runs-on: ubuntu-latest
    
  #   steps:
  #     - name: Checkout c√≥digo
  #       uses: actions/checkout@v4

  #     - name: Configurar Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #         cache: 'npm'

  #     - name: Instalar dependencias
  #       run: npm ci

  #     - name: Verificar tipos TypeScript
  #       run: npm run check

  #     - name: Ejecutar tests
  #       run: npm test

  #     - name: Construir proyecto
  #       run: npm run build

  deploy:
    name: Desplegar a AWS
    runs-on: ubuntu-latest
    environment: aws
    # needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Construir proyecto
        run: npm run build

      - name: Instalar AWS SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Configurar credenciales AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Construir con SAM
        run: |
          export PATH="$PATH:$(pwd)/node_modules/.bin"
          sam build

      - name: Desplegar con SAM
        run: |
          sam deploy \
            --parameter-overrides \
              DatabaseHost="${{ secrets.DATABASE_HOST }}" \
              DatabaseName="${{ secrets.DATABASE_NAME }}" \
              DatabaseUser="${{ secrets.DATABASE_USER }}" \
              DatabasePassword="${{ secrets.DATABASE_PASSWORD }}" \
              JwtSecret="${{ secrets.JWT_SECRET }}" \
              SubnetIds="${{ secrets.SUBNET_IDS }}" \
              SecurityGroupId="${{ secrets.SECURITY_GROUP_ID }}" \
              AllowedOrigins="${{ secrets.ALLOWED_ORIGINS }}" \
              OAuthServerUrl="${{ secrets.OAUTH_SERVER_URL }}" \
              ViteAppId="${{ secrets.VITE_APP_ID }}" \
              OAuthClientSecret="${{ secrets.OAUTH_CLIENT_SECRET }}" \
              OwnerOpenId="${{ secrets.OWNER_OPEN_ID }}" \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset

      - name: Obtener URL de la API
        id: get-api-url
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name foodoffice-backend \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
            --output text)
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "API desplegada en: $API_URL"

      - name: Verificar Security Groups
        run: |
          echo "üîç Verificando configuraci√≥n de Security Groups..."
          
          LAMBDA_SG="${{ secrets.SECURITY_GROUP_ID }}"
          RDS_SG="${{ secrets.RDS_SECURITY_GROUP_ID }}"
          
          if [ -z "$RDS_SG" ]; then
            echo "‚ö†Ô∏è  RDS_SECURITY_GROUP_ID no est√° configurado. Saltando verificaci√≥n de Security Groups."
            exit 0
          fi
          
          # Verificar Lambda Security Group (Egress)
          echo "1Ô∏è‚É£  Verificando Lambda Security Group (Egress)..."
          LAMBDA_OUTBOUND=$(aws ec2 describe-security-groups \
            --group-ids $LAMBDA_SG \
            --query 'SecurityGroups[0].IpPermissionsEgress[?FromPort==`5432` && ToPort==`5432` && IpProtocol==`tcp`]' \
            --output json 2>/dev/null || echo "[]")
          
          if [ "$LAMBDA_OUTBOUND" == "[]" ] || [ "$LAMBDA_OUTBOUND" == "null" ]; then
            echo "‚ùå Lambda Security Group NO permite tr√°fico saliente al puerto 5432"
            echo "   Configura la regla:"
            echo "   aws ec2 authorize-security-group-egress \\"
            echo "     --group-id $LAMBDA_SG \\"
            echo "     --ip-permissions IpProtocol=tcp,FromPort=5432,ToPort=5432,UserIdGroupPairs=[{GroupId=$RDS_SG}]"
            exit 1
          else
            # Verificar que permite hacia RDS espec√≠ficamente
            ALLOWS_RDS=$(echo "$LAMBDA_OUTBOUND" | jq -r '.[] | select(.UserIdGroupPairs[].GroupId == "'$RDS_SG'") | .UserIdGroupPairs[].GroupId' 2>/dev/null || echo "")
            if [ -z "$ALLOWS_RDS" ]; then
              echo "‚ö†Ô∏è  Lambda Security Group permite tr√°fico al 5432, pero NO espec√≠ficamente hacia RDS Security Group"
              echo "   Se recomienda configurar la regla espec√≠fica para mayor seguridad"
            else
              echo "‚úÖ Lambda Security Group permite tr√°fico saliente al puerto 5432 hacia RDS"
            fi
          fi
          
          # Verificar RDS Security Group (Ingress)
          echo "2Ô∏è‚É£  Verificando RDS Security Group (Ingress)..."
          RDS_INBOUND=$(aws ec2 describe-security-groups \
            --group-ids $RDS_SG \
            --query 'SecurityGroups[0].IpPermissions[?FromPort==`5432` && ToPort==`5432` && IpProtocol==`tcp`]' \
            --output json 2>/dev/null || echo "[]")
          
          if [ "$RDS_INBOUND" == "[]" ] || [ "$RDS_INBOUND" == "null" ]; then
            echo "‚ùå RDS Security Group NO permite tr√°fico entrante en el puerto 5432"
            echo "   Configura la regla:"
            echo "   aws ec2 authorize-security-group-ingress \\"
            echo "     --group-id $RDS_SG \\"
            echo "     --ip-permissions IpProtocol=tcp,FromPort=5432,ToPort=5432,UserIdGroupPairs=[{GroupId=$LAMBDA_SG}]"
            exit 1
          else
            # Verificar que permite desde Lambda espec√≠ficamente
            ALLOWS_LAMBDA=$(echo "$RDS_INBOUND" | jq -r '.[] | select(.UserIdGroupPairs[].GroupId == "'$LAMBDA_SG'") | .UserIdGroupPairs[].GroupId' 2>/dev/null || echo "")
            if [ -z "$ALLOWS_LAMBDA" ]; then
              echo "‚ùå RDS Security Group permite tr√°fico en 5432, pero NO desde Lambda Security Group"
              echo "   Configura la regla:"
              echo "   aws ec2 authorize-security-group-ingress \\"
              echo "     --group-id $RDS_SG \\"
              echo "     --ip-permissions IpProtocol=tcp,FromPort=5432,ToPort=5432,UserIdGroupPairs=[{GroupId=$LAMBDA_SG}]"
              exit 1
            else
              echo "‚úÖ RDS Security Group permite tr√°fico entrante desde Lambda en puerto 5432"
            fi
          fi
          
          echo "‚úÖ Security Groups configurados correctamente"

      - name: Esperar propagaci√≥n de cambios
        run: |
          echo "‚è≥ Esperando 15 segundos para que los cambios se propaguen..."
          sleep 15

      - name: Verificar conexi√≥n a base de datos
        run: |
          echo "üîç Verificando conexi√≥n a la base de datos..."
          
          API_URL="${{ steps.get-api-url.outputs.api_url }}"
          MAX_RETRIES=5
          RETRY_DELAY=10
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Intento $i/$MAX_RETRIES..."
            
            RESPONSE=$(curl -s -w "\n%{http_code}" "$API_URL/api/db-check" || echo "")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" == "200" ]; then
              SUCCESS=$(echo "$BODY" | jq -r '.success' 2>/dev/null || echo "false")
              
              if [ "$SUCCESS" == "true" ]; then
                echo "‚úÖ Conexi√≥n a la base de datos exitosa"
                echo "$BODY" | jq '.'
                
                # Verificar si las tablas existen
                TABLES_EXIST=$(echo "$BODY" | jq -r '.tablesExist' 2>/dev/null || echo "false")
                if [ "$TABLES_EXIST" == "true" ]; then
                  echo "‚úÖ Las tablas existen en la base de datos"
                else
                  echo "‚ö†Ô∏è  Las tablas no existen. Se ejecutar√°n las migraciones."
                fi
                
                exit 0
              else
                ERROR=$(echo "$BODY" | jq -r '.error' 2>/dev/null || echo "Error desconocido")
                echo "‚ùå Error en la conexi√≥n: $ERROR"
                
                # Mostrar troubleshooting si est√° disponible
                TROUBLESHOOTING=$(echo "$BODY" | jq -r '.troubleshooting[]?' 2>/dev/null || echo "")
                if [ -n "$TROUBLESHOOTING" ]; then
                  echo "üí° Troubleshooting:"
                  echo "$TROUBLESHOOTING" | while read line; do
                    echo "   - $line"
                  done
                fi
                
                if [ $i -lt $MAX_RETRIES ]; then
                  echo "‚è≥ Reintentando en $RETRY_DELAY segundos..."
                  sleep $RETRY_DELAY
                else
                  echo "‚ùå No se pudo conectar a la base de datos despu√©s de $MAX_RETRIES intentos"
                  exit 1
                fi
              fi
            else
              echo "‚ùå Error HTTP $HTTP_CODE al verificar conexi√≥n"
              echo "Respuesta: $BODY"
              
              if [ $i -lt $MAX_RETRIES ]; then
                echo "‚è≥ Reintentando en $RETRY_DELAY segundos..."
                sleep $RETRY_DELAY
              else
                echo "‚ùå No se pudo verificar la conexi√≥n despu√©s de $MAX_RETRIES intentos"
                exit 1
              fi
            fi
          done

      - name: Ejecutar migraciones de base de datos
        env:
          DATABASE_URL: postgresql://${{ secrets.DATABASE_USER }}:${{ secrets.DATABASE_PASSWORD }}@${{ secrets.DATABASE_HOST }}:5432/${{ secrets.DATABASE_NAME }}
        run: |
          echo "üîÑ Ejecutando migraciones de base de datos..."
          npm run db:push
          echo "‚úÖ Migraciones completadas"
          
          # Verificar nuevamente despu√©s de las migraciones
          echo "üîç Verificando conexi√≥n despu√©s de las migraciones..."
          API_URL="${{ steps.get-api-url.outputs.api_url }}"
          sleep 5
          
          RESPONSE=$(curl -s "$API_URL/api/db-check" || echo "")
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success' 2>/dev/null || echo "false")
          TABLES_EXIST=$(echo "$RESPONSE" | jq -r '.tablesExist' 2>/dev/null || echo "false")
          
          if [ "$SUCCESS" == "true" ] && [ "$TABLES_EXIST" == "true" ]; then
            echo "‚úÖ Base de datos conectada y tablas disponibles"
          elif [ "$SUCCESS" == "true" ]; then
            echo "‚ö†Ô∏è  Base de datos conectada pero las tablas a√∫n no existen"
            echo "   Esto puede ser normal si las migraciones est√°n en progreso"
          else
            echo "‚ùå Error en la conexi√≥n despu√©s de las migraciones"
            echo "$RESPONSE" | jq '.'
            exit 1
          fi
